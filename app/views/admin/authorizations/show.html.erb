<% content_for :page_title, "権限管理" %>

<div class="mx-auto max-w-6xl px-4 py-6 sm:px-6 lg:px-8">
  <div class="mb-6 rounded-2xl border border-slate-200 bg-gradient-to-r from-slate-900 via-slate-800 to-slate-700 px-6 py-5 text-white shadow-lg">
    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <p class="text-xs font-semibold tracking-wide text-slate-200 uppercase">Tenant Scoped RBAC</p>
        <h1 class="text-2xl font-bold leading-tight">権限管理</h1>
        <p class="mt-1 text-sm text-slate-200">
          現在のテナントで利用できるロールに対して、リソース別の権限を割り当てます。画面表示だけでなく、URL直打ちも Pundit で遮断します。
        </p>
      </div>
      <div class="flex flex-col items-start gap-2 sm:items-end">
        <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold text-white ring-1 ring-white/30">
          テナント: <%= current_tenant&.name || "未設定" %>
        </span>
        <% if current_tenant.present? %>
          <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-[11px] font-semibold text-slate-100 ring-1 ring-white/20">
            <%= current_tenant.code %> / <%= current_tenant.subdomain %>
          </span>
        <% end %>
      </div>
    </div>
  </div>

  <div class="mb-4 grid gap-3 sm:grid-cols-2">
    <div class="rounded-xl border border-slate-200 bg-white/90 px-4 py-3 shadow-sm">
      <p class="text-sm font-semibold text-slate-800">運用上の前提</p>
      <ul class="mt-2 space-y-1 text-xs text-slate-600">
        <li>・全て current_tenant 配下のロールのみが対象です（他テナントは policy_scope で除外）。</li>
        <li>・Owner ロールはロックされており、権限変更不可です。</li>
        <li>・チェックが無い権限は controller / view 両方で拒否されます。</li>
      </ul>
    </div>
    <div class="rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 shadow-sm text-xs text-amber-800">
      <p class="text-sm font-semibold">安全装置</p>
      <ul class="mt-1 space-y-1">
        <li>・更新はトランザクションで実行し、中途半端な状態を防止。</li>
        <li>・Pundit が 403 を返すため、URL直打ちや JS 偽装も阻止。</li>
        <li>・チェックボックスはロール×権限のマトリクスで明示。</li>
      </ul>
    </div>
  </div>

  <% if @roles.empty? %>
    <div class="rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-600 shadow-sm">
      このテナントにロールが存在しません。先にロールを作成してください。
    </div>
  <% elsif @permissions.empty? %>
    <div class="rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-600 shadow-sm">
      権限定義がまだありません。Permission レコードを登録してから再度開いてください。
    </div>
  <% else %>
    <%= form_with url: admin_authorization_path, method: :patch, local: true do %>
      <div class="mb-4 flex items-center justify-between">
        <div>
          <p class="text-xs font-semibold uppercase text-slate-500">Role Matrix</p>
          <p class="text-sm text-slate-700">ロール列にチェックを入れて保存すると、対応する RolePermission が登録されます。</p>
        </div>
        <%= submit_tag "権限を保存", class: "inline-flex items-center rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-700" %>
      </div>

      <% @permissions_by_resource.each do |resource, permissions| %>
        <div class="mb-6 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
          <div class="flex items-center justify-between border-b border-slate-100 px-4 py-3">
            <div>
              <p class="text-sm font-semibold text-slate-900"><%= resource.titleize %></p>
              <p class="text-[11px] text-slate-500">リソース単位の権限を設定します。</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <% @roles.each do |role| %>
                <% locked = locked_role?(role) %>
                <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-[11px] font-semibold ring-1 <%= locked ? "bg-slate-100 text-slate-500 ring-slate-200" : "bg-sky-50 text-sky-800 ring-sky-200" %>">
                  <%= role.name %>
                  <% if locked %>
                    <span class="text-[10px] font-semibold text-slate-500">LOCK</span>
                  <% end %>
                </span>
              <% end %>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-left text-xs">
              <thead class="bg-slate-50 text-slate-500">
                <tr>
                  <th class="px-4 py-2 font-medium w-2/5">権限</th>
                  <th class="px-3 py-2 font-medium w-1/5">アクション</th>
                  <% @roles.each do |role| %>
                    <th class="px-3 py-2 font-medium text-center"><%= role.name %></th>
                  <% end %>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                <% permissions.each do |permission| %>
                  <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 align-top">
                      <p class="text-sm font-semibold text-slate-900"><%= permission.name %></p>
                      <p class="text-[11px] text-slate-500"><%= permission.description.presence || permission.key %></p>
                    </td>
                    <td class="px-3 py-3 align-top text-[11px] uppercase tracking-wide text-slate-600">
                      <%= permission.action %>
                    </td>
                    <% @roles.each do |role| %>
                      <% locked = locked_role?(role) %>
                      <td class="px-3 py-2 text-center align-middle">
                        <div class="inline-flex items-center justify-center rounded-md border <%= locked ? 'border-slate-200 bg-slate-50' : 'border-slate-200 bg-white' %> px-2 py-1">
                          <%= check_box_tag "role_permissions[#{role.id}][permission_ids][]",
                              permission.id,
                              role.permissions.include?(permission),
                              disabled: locked,
                              class: "h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500" %>
                        </div>
                      </td>
                    <% end %>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>

      <div class="mt-4 flex justify-end">
        <%= submit_tag "権限を保存", class: "inline-flex items-center rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-700" %>
      </div>
    <% end %>
  <% end %>
</div>
