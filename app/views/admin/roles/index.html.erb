<% content_for :page_title, "ロール一覧" %>

<div class="mx-auto max-w-6xl px-4 py-6 sm:px-6 lg:px-8">
  <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-xl font-semibold text-slate-900">
        ロール一覧
      </h1>
      <p class="mt-1 text-sm text-slate-500">
        このテナントで利用できるロールの一覧です。キーは重複しないように管理してください。
      </p>
      <p class="mt-1 text-xs text-slate-500">
        テナント名をクリックすると、検索欄にセットしてサジェスト検索を実行します。
      </p>
    </div>
    <div class="flex flex-col items-start gap-2 sm:items-end">
      <div class="flex items-center gap-2 text-xs text-slate-500">
        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-1 font-semibold text-slate-700">
          コード: <%= @tenant.code %>
        </span>
        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-1 font-semibold text-slate-700">
          サブドメイン: <%= @tenant.subdomain %>
        </span>
      </div>

      <%= form_with url: admin_tenant_roles_path(@tenant), method: :get, local: true, id: "tenant-search-form", class: "grid w-full grid-cols-1 gap-2 text-xs sm:grid-cols-5" do |f| %>
        <div class="sm:col-span-2">
          <%= f.label :tenant_name, "テナント名", class: "text-slate-600" %>
          <%= f.select :tenant_name,
              options_for_select(@tenant_options.map { |t| [t.name, t.name] }, @tenant_search_name.presence || @tenant.name),
              { include_blank: "選択してください" },
              class: "mt-1 w-full rounded-lg border border-slate-200 px-3 py-1.5 text-xs focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500", 
              style: "height: 28px;" %>
          <p class="mt-1 text-[11px] text-slate-500">リストにない場合は他の条件（コード/サブドメイン）で検索してください。</p>
        </div>
        <div>
          <%= f.label :tenant_code, "コード", class: "text-slate-600" %>
          <%= f.search_field :tenant_code,
              value: @tenant_search_code,
              placeholder: "例: tenant_001",
              class: "mt-1 w-full rounded-lg border border-slate-200 px-3 py-1.5 text-xs focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500" %>
        </div>
        <div>
          <%= f.label :tenant_subdomain, "サブドメイン", class: "text-slate-600" %>
          <%= f.search_field :tenant_subdomain,
              value: @tenant_search_subdomain,
              placeholder: "例: acme",
              class: "mt-1 w-full rounded-lg border border-slate-200 px-3 py-1.5 text-xs focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500" %>
        </div>
        <div class="flex items-end gap-2">
          <%= f.submit "検索", class: "w-full rounded-lg bg-sky-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-sky-700" %>
        </div>
      <% end %>
    </div>
  </div>

  <% if [@tenant_search_name, @tenant_search_code, @tenant_search_subdomain].any?(&:present?) %>
    <div class="mb-4 rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-700">
      <p class="font-semibold">
        検索結果（最大10件）
        <% if @tenant_search_name.present? %> / 名前: "<%= @tenant_search_name %>"<% end %>
        <% if @tenant_search_code.present? %> / コード: "<%= @tenant_search_code %>"<% end %>
        <% if @tenant_search_subdomain.present? %> / サブドメイン: "<%= @tenant_search_subdomain %>"<% end %>
      </p>
      <% if @tenant_search_results.any? %>
        <ul class="mt-2 grid gap-2 sm:grid-cols-2">
          <% @tenant_search_results.each do |tenant| %>
            <li class="rounded border border-slate-200 bg-white px-3 py-2 hover:bg-slate-50">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-slate-900"><%= tenant.name %></p>
                  <p class="text-[11px] text-slate-500"><%= tenant.code %> / <%= tenant.subdomain %></p>
                </div>
                <%= button_to "ロールを見る",
                    admin_tenant_roles_path(tenant),
                    method: :get,
                    form_class: "m-0",
                    class: "rounded border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-700 hover:bg-slate-100" %>
              </div>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="mt-1 text-slate-500">該当するテナントが見つかりませんでした。</p>
      <% end %>
    </div>
  <% end %>

  <%= form_with url: admin_tenant_roles_path(@tenant), method: :post, local: true, id: "roles-save-form" do %>
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm">
      <div class="flex items-center justify-between border-b border-slate-100 px-4 py-3 text-xs text-slate-500">
        <span>全 <%= @roles.size %> 件</span>
        <div class="flex items-center gap-2">
          <button
            type="button"
            id="add-role-row"
            class="inline-flex items-center rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50"
          >
            ロール追加
          </button>
          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-lg bg-sky-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-sky-700"
            style="min-width: 86px; text-align: center"
          >
            保存
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-left text-xs">
          <thead class="bg-slate-50 text-slate-500">
            <tr>
              <th class="px-3 py-2 font-medium">ロール名</th>
              <th class="px-3 py-2 font-medium">キー</th>
              <th class="px-3 py-2 font-medium">説明</th>
              <th class="px-3 py-2 font-medium text-center">組み込み</th>
              <th class="px-3 py-2 font-medium text-right">作成日</th>
            </tr>
          </thead>
          <tbody id="roles-table-body" class="divide-y divide-slate-100">
            <% @roles.each do |role| %>
              <tr class="hover:bg-slate-50">
                <td class="px-3 py-2 align-middle">
                  <span class="text-sm font-semibold text-slate-900"><%= role.name %></span>
                </td>
                <td class="px-3 py-2 align-middle text-[11px] text-slate-700"><%= role.key %></td>
                <td class="px-3 py-2 align-middle text-[11px] text-slate-600"><%= role.description.presence || "—" %></td>
                <td class="px-3 py-2 align-middle text-center">
                  <% if role.built_in? %>
                    <span class="inline-flex items-center rounded-full bg-slate-900/90 px-2 py-0.5 text-[11px] font-semibold text-white">Yes</span>
                  <% else %>
                    <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-semibold text-slate-600">No</span>
                  <% end %>
                </td>
                <td class="px-3 py-2 align-middle text-right text-[11px] text-slate-600">
                  <%= role.created_at&.strftime("%Y-%m-%d") %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>

<template id="role-row-template">
  <tr class="hover:bg-slate-50 bg-slate-50/60">
    <td class="px-3 py-2 align-middle">
      <input
        data-role-name-input
        type="text"
        name="roles[][name]"
        class="w-full rounded border border-slate-200 px-2 py-1 text-sm font-semibold text-slate-900 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
        value="新規ロール（未保存）"
      />
    </td>
    <td class="px-3 py-2 align-middle">
      <input
        data-role-key-input
        type="text"
        name="roles[][key]"
        class="w-full rounded border border-slate-200 px-2 py-1 text-[11px] text-slate-700 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
        value="new_role"
      />
    </td>
    <td class="px-3 py-2 align-middle">
      <input
        data-role-description-input
        type="text"
        name="roles[][description]"
        class="w-full rounded border border-slate-200 px-2 py-1 text-[11px] text-slate-600 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
        placeholder="説明を入力"
      />
    </td>
    <td class="px-3 py-2 align-middle text-center">
      <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-semibold text-slate-600">No</span>
    </td>
    <td class="px-3 py-2 align-middle text-right text-[11px] text-slate-600" data-role-created-at>YYYY-MM-DD</td>
  </tr>
</template>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const suggestButton = document.getElementById("tenant-name-suggest");
    const form = document.getElementById("tenant-search-form");
    const nameField = document.getElementById("tenant_name");

    if (!suggestButton || !form || !nameField) return;

    suggestButton.addEventListener("click", () => {
      nameField.value = suggestButton.dataset.tenantName || "";
      form.requestSubmit();
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    const addRoleButton = document.getElementById("add-role-row");
    const rolesTbody = document.getElementById("roles-table-body");
    const template = document.getElementById("role-row-template");
    let newRoleCounter = 1;

    if (!addRoleButton || !rolesTbody || !template) return;

    addRoleButton.addEventListener("click", () => {
      const clone = template.content.firstElementChild.cloneNode(true);
      const nameInput = clone.querySelector("[data-role-name-input]");
      const keyInput = clone.querySelector("[data-role-key-input]");
      const descInput = clone.querySelector("[data-role-description-input]");
      const createdEl = clone.querySelector("[data-role-created-at]");
      const number = newRoleCounter++;

      if (nameInput) nameInput.value = ``;
      if (keyInput) keyInput.value = ``;
      if (descInput) descInput.value = "";
      if (createdEl) createdEl.textContent = new Date().toISOString().slice(0, 10);

      rolesTbody.prepend(clone);
      if (nameInput) nameInput.focus();
    });
  });
</script>
