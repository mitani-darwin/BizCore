<% content_for :page_title, "ダッシュボード" %>

<div class="space-y-6">
  <% visible_steps = @onboarding_steps.select { |step| step[:permission_key].blank? || can?(step[:permission_key]) } %>
  <% pending_steps = visible_steps.reject { |step| step[:done] } %>
  <% if pending_steps.any? %>
    <% done_count = visible_steps.count { |step| step[:done] } %>
    <% next_step = pending_steps.find { |step| step[:path].present? } %>
    <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <p class="text-xs font-semibold text-slate-500">初期セットアップ</p>
          <h2 class="text-lg font-semibold text-slate-900">最初にやること</h2>
          <p class="mt-1 text-sm text-slate-600">迷わず始められるよう、必要最低限だけに絞っています。</p>
        </div>
        <div class="text-right text-xs text-slate-500">
          <div class="text-lg font-semibold text-slate-900"><%= done_count %>/<%= visible_steps.size %></div>
          <div>完了</div>
          <% if next_step %>
            <%= link_to "次に進む", next_step[:path], class: "mt-2 inline-flex items-center rounded-full bg-slate-900 px-3 py-1 text-[11px] font-semibold text-white hover:bg-slate-800" %>
          <% end %>
        </div>
      </div>

      <div class="mt-4 space-y-2">
        <% visible_steps.each do |step| %>
          <div class="flex items-center justify-between rounded-lg border border-slate-100 px-3 py-2">
            <div class="flex items-center gap-2">
              <% if step[:done] %>
                <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-50 text-emerald-600 text-xs font-bold">✓</span>
              <% else %>
                <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-100 text-slate-500 text-xs font-bold"><%= visible_steps.index(step) + 1 %></span>
              <% end %>
              <span class="text-sm text-slate-800"><%= step[:label] %></span>
            </div>
            <% if step[:done] %>
              <span class="text-xs font-semibold text-emerald-700">完了</span>
            <% elsif step[:path].present? %>
              <%= link_to "実行する", step[:path], class: "rounded-md border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50" %>
            <% else %>
              <span class="text-xs text-slate-400">権限なし</span>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="grid gap-4 md:grid-cols-3">
    <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <p class="text-xs font-semibold text-slate-500">テナント</p>
      <p class="mt-2 text-lg font-bold text-slate-900"><%= @tenant&.name || "未設定" %></p>
      <p class="text-xs text-slate-500"><%= @tenant&.code %> / <%= @tenant&.subdomain %></p>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <p class="text-xs font-semibold text-slate-500">ユーザー数</p>
      <p class="mt-2 text-3xl font-bold text-slate-900"><%= @user_count %></p>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <p class="text-xs font-semibold text-slate-500">ロール数</p>
      <p class="mt-2 text-3xl font-bold text-slate-900"><%= @role_count %></p>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
      <h2 class="text-sm font-semibold text-slate-800">クイックアクセス</h2>
      <div class="mt-3 space-y-2 text-sm">
        <% if can?("admin.tenants.read") %>
          <%= link_to "テナント設定", admin_tenants_path, class: "block rounded-lg border border-slate-200 px-3 py-2 hover:bg-slate-50" %>
        <% end %>
        <% if can?("admin.roles.read") %>
          <%= link_to "ロール管理", admin_roles_path, class: "block rounded-lg border border-slate-200 px-3 py-2 hover:bg-slate-50" %>
        <% end %>
        <% if can?("admin.users.read") %>
          <%= link_to "ユーザー一覧", admin_users_path, class: "block rounded-lg border border-slate-200 px-3 py-2 hover:bg-slate-50" %>
        <% end %>
      </div>
    </div>

    <div class="rounded-xl border border-amber-200 bg-amber-50 p-5 text-sm text-amber-800 shadow-sm">
      <p class="font-semibold">権限について</p>
      <p class="mt-1">
        管理画面は権限キーによって保護され、権限がない場合は 404 を返します。
      </p>
    </div>
  </div>

  <% if can?("admin.audit_logs.read") %>
    <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold text-slate-800">最近の操作</h2>
        <%= link_to "監査ログへ", admin_audit_logs_path, class: "text-xs font-semibold text-sky-700 hover:underline" %>
      </div>
      <% if @recent_audit_logs.any? %>
        <div class="mt-3 space-y-2 text-sm">
          <% @recent_audit_logs.each do |log| %>
            <div class="flex items-center justify-between rounded-lg border border-slate-100 px-3 py-2">
              <div>
                <div class="text-xs text-slate-500"><%= l log.created_at, format: :short %></div>
                <div class="text-sm text-slate-800"><%= log.action_key %></div>
              </div>
              <span class="text-[11px] text-slate-500"><%= log.actor&.try(:name) || "System" %></span>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="mt-3 rounded-lg border border-dashed border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600">
          まだ操作履歴がありません。最初の更新を行うとここに表示されます。
        </div>
      <% end %>
    </div>
  <% end %>
</div>
